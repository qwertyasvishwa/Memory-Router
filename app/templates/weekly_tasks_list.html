{% extends "base.html" %}
{% block content %}
<div class="card">
    <h2>Weekly tracker history</h2>
    <p>All generated macro tasks and overlooked actions in one place.</p>

    <!-- Enhanced Filter Bar for List View -->
    <div class="filters-section">
        <h4>Advanced Filters & Analysis</h4>

        <!-- Summary Stats -->
        <div class="summary-bar">
            <div class="summary-item">
                <strong>{{ total_entries }}</strong> entries found
            </div>
            {% if activity_summary %}
            <div class="summary-item">
                <strong>Activity breakdown:</strong>
                {% for activity, count in activity_summary.items() %}
                <span class="activity-badge" data-activity="{{ activity }}">
                    {{ activity.replace("_", " ").title() }} ({{ count }})
                </span>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Comprehensive Filter Form -->
        <form action="/weekly-tasks/list" method="get" class="filter-form">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="list_project">Project</label>
                    <select id="list_project" name="project" data-tom-select>
                        <option value="">All Projects</option>
                        {% for proj in all_projects %}
                        <option value="{{ proj }}" {% if project_filter==proj %}selected{% endif %}>
                            {{ proj }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="list_activity_types">Activity Types</label>
                    <select id="list_activity_types" name="activity_types" multiple data-tom-select>
                        {% set selected_types = activity_types_filter or [] %}
                        {% for kind in activity_types %}
                        <option value="{{ kind.value }}" {% if kind.value in selected_types %}selected{% endif %}>
                            {{ kind.display_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label for="list_keyword">Search</label>
                    <input id="list_keyword" name="keyword" type="text" value="{{ keyword_filter }}"
                        placeholder="Search tasks, context, projects...">
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <label for="list_date_from">From</label>
                    <input id="list_date_from" name="date_from" type="date" value="{{ date_from_filter }}">
                </div>

                <div class="filter-group">
                    <label for="list_date_to">To</label>
                    <input id="list_date_to" name="date_to" type="date" value="{{ date_to_filter }}">
                </div>

                <div class="filter-group">
                    <label for="list_group_by">Group By</label>
                    <select id="list_group_by" name="group_by">
                        <option value="">Date Order</option>
                        <option value="project" {% if group_by=='project' %}selected{% endif %}>Project</option>
                        <option value="activity" {% if group_by=='activity' %}selected{% endif %}>Activity</option>
                    </select>
                </div>
            </div>

            <div class="filter-actions">
                <button type="submit">Apply Filters</button>
                <a href="/weekly-tasks/list" class="btn-secondary">Clear All</a>
                <div class="quick-filters">
                    <button type="button" onclick="setDateRange(7)" class="btn-small">Last 7d</button>
                    <button type="button" onclick="setDateRange(30)" class="btn-small">Last 30d</button>
                    <button type="button" onclick="setDateRange(90)" class="btn-small">This Quarter</button>
                </div>
            </div>
        </form>
    </div>

    {% if weekly_history %}
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Project</th>
                <th>Context</th>
                <th>Activity</th>
                <th>Key outcomes</th>
                <th>Follow-ups / risks</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in weekly_history %}
            <tr>
                <td>{{ entry.created_at.strftime("%Y-%m-%d %H:%M UTC") }}</td>
                <td>{{ entry.project or "—" }}</td>
                <td>{{ entry.context or "—" }}</td>
                <td>{{ entry.activity_type.value.replace("_", " ").title() }}</td>
                <td>
                    <ul>
                        {% for task in entry.generated_tasks %}
                        <li>{{ task }}</li>
                        {% endfor %}
                    </ul>
                </td>
                <td>
                    <ul>
                        {% for task in entry.overlooked_tasks %}
                        <li>{{ task }}</li>
                        {% endfor %}
                    </ul>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No weekly tracker entries yet.</p>
    {% endif %}
</div>
{% endblock %}
